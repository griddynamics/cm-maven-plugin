<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia at 2015-02-17 
 | Rendered using Apache Maven Fluido Skin 1.3.1
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20150217" />
    <meta http-equiv="Content-Language" content="en" />
    <title>cm-maven-plugin &#x2013; </title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.3.1.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />

      
    <script type="text/javascript" src="./js/apache-maven-fluido-1.3.1.min.js"></script>

    
                  </head>
        <body class="topBarDisabled">
          
        
    
        <div class="container-fluid">
          <div id="banner">
        <div class="pull-left">
                                    <a href="http://www.griddynamics.com/" id="bannerLeft">
                                                                                        <img src="http://www.griddynamics.com/wp-content/themes/grid/images/logo.png"  alt="Grid Dynamics"/>
                </a>
                      </div>
        <div class="pull-right">  </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
                
                    
                  <li id="publishDate">Last Published: 2015-02-17
                      <span class="divider">|</span>
                   </li>
                  <li id="projectVersion">Version: 1.3.0
                      </li>
                      
                
                    
      
                            </ul>
      </div>

            
      <div class="row-fluid">
        <div id="leftColumn" class="span3">
          <div class="well sidebar-nav">
                
                    
                <ul class="nav nav-list">
                    <li class="nav-header">Overview</li>
                              
      <li>
  
                          <a href="index.html" title="Introduction">
          <i class="none"></i>
        Introduction</a>
            </li>
                
      <li>
  
                          <a href="plugin-info.html" title="Goals">
          <i class="none"></i>
        Goals</a>
            </li>
                                                                                                                                                                      
      <li class="active">
  
            <a href="#"><i class="icon-chevron-down"></i>Usage</a>
                  <ul class="nav nav-list">
                    
      <li>
  
                          <a href="usage.html#Configuration_layers" title="Layers">
          <i class="none"></i>
        Layers</a>
            </li>
                                                                                                                      
      <li>
  
                          <a href="usage.html#Merge_algorithms" title="Algorithms">
          <i class="icon-chevron-down"></i>
        Algorithms</a>
                    <ul class="nav nav-list">
                    
      <li>
  
                          <a href="usage/tree.html" title="Tree">
          <i class="none"></i>
        Tree</a>
            </li>
                    
      <li>
  
                          <a href="usage/file.html" title="File">
          <i class="none"></i>
        File</a>
            </li>
                    
      <li>
  
                          <a href="usage/data.html" title="Data">
          <i class="none"></i>
        Data</a>
            </li>
                    
      <li>
  
                          <a href="usage/data-processors.html" title="Processors">
          <i class="none"></i>
        Processors</a>
            </li>
              </ul>
        </li>
              </ul>
        </li>
                              <li class="nav-header">Advanced topics</li>
                              
      <li>
  
                          <a href="advanced/best-practices.html" title="Best practices">
          <i class="none"></i>
        Best practices</a>
            </li>
                
      <li>
  
                          <a href="advanced/api.html" title="API">
          <i class="none"></i>
        API</a>
            </li>
                              <li class="nav-header">Project documentation</li>
                                                                                                                                                                                            
      <li>
  
                          <a href="project-info.html" title="Project information">
          <i class="icon-chevron-right"></i>
        Project information</a>
                  </li>
            </ul>
                
                    
                
          <hr />

           <div id="poweredBy">
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />
      </a>
                  </div>
          </div>
        </div>
        
                
        <div id="bodyColumn"  class="span9" >
                                  
            <div class="section">
<h2><a name="Usage"></a>Usage</h2>
<p>In order to use lifecycle provided in plugin for convenience, just set &lt;packaging/&gt; to <i>configuration</i> and <b>enable plugin extensions</b> in plugin configuration.</p>
<div>
<pre>&lt;project&gt;
  ...
  &lt;packaging&gt;configuration&lt;/packaging&gt;
  ...
  &lt;build&gt;
    &lt;plugins&gt;
      &lt;plugin&gt;
        &lt;groupId&gt;com.griddynamics.maven.plugins&lt;/groupId&gt;
        &lt;artifactId&gt;cm-maven-plugin&lt;/artifactId&gt;
        &lt;version&gt;1.3.0-SNAPSHOT&lt;/version&gt;
        &lt;extensions&gt;true&lt;/extensions&gt;
      &lt;/plugin&gt;
      ...
    &lt;/plugins&gt;
  &lt;/build&gt;
  ...
&lt;/project&gt;</pre></div>
<div class="section">
<h3><a name="Configuration_layers">Configuration layers</a></h3>
<p>There may be as much configuration layers as required by specific project. Configuration layers are defined using plugin configuration in the following way:</p>
<div>
<pre>&lt;configuration&gt;
  ...
  &lt;layers&gt;
    &lt;layer&gt;
      &lt;name&gt;application&lt;/name&gt;
    &lt;/layer&gt;
    &lt;layer&gt;
      &lt;name&gt;environment&lt;/name&gt;
    &lt;/layer&gt;
    &lt;layer&gt;
      &lt;name&gt;instance&lt;/name&gt;
    &lt;/layer&gt;
  &lt;/layers&gt;
  ...
&lt;/configuration&gt;</pre></div>
<p>Such configuration layer structure defines the following project structure:</p>
<div>
<pre>&#x251c;&#x2500;application
&#x2502; &#x251c;&#x2500;config
&#x2502; &#x2502; &#x2514;&#x2500;...
&#x2502; &#x2514;&#x2500;environment
&#x2502;   &#x251c;&#x2500;qa
&#x2502;   &#x2502; &#x2514;...
&#x2502;   &#x251c;&#x2500;uat
&#x2502;   &#x2502; &#x2514;...
&#x2502;   &#x2514;&#x2500;prod
&#x2502;     &#x251c;&#x2500;config
&#x2502;     &#x2502; &#x2514;...
&#x2502;     &#x2514;&#x2500;instance
&#x2502;       &#x251c;&#x2500;frontend
&#x2502;       &#x2502; &#x2514;&#x2500;config
&#x2502;       &#x2502;   &#x2514;...
&#x2502;       &#x2514;&#x2500;backend
&#x2502;         &#x2514;&#x2500;config
&#x2502;           &#x2514;...
&#x2514;&#x2500;pom.xml</pre></div>
<p>Every layer in this tree is optional. However, creating directory (qa, uat, prod, frontent, backend) of the desired layer will give plugin a signal, that such layer exists.</p>
<p>By default plugin creates only leafs of configuration tree which may be overridden in layers configuration:</p>
<div>
<pre>[...]
&lt;layer&gt;
  &lt;name&gt;environment&lt;/name&gt;
  &lt;includeNode&gt;true&lt;/includeNode&gt;
  &lt;includeLeaf&gt;false&lt;/includeLeaf&gt;
&lt;/layer&gt;
[...]</pre></div>
<ul>
<li><b>includeNode</b> set to true tells plugin to build configuration artifact even if there is more specific layer.</li>
<li><b>includeLeaf</b> set to false tells plugin not to build configuration artifact if there are no more specific layers.
<p>Of course these two options may be used separately. By default <b>includeNode</b>=false, <b>includeLeaf</b>=true which makes plugin to build only configuration tree leafs.</p>
<p>The next section describes in details how configuration is merged.</p></li></ul></div>
<div class="section">
<h3><a name="Merge_algorithms">Merge algorithms</a></h3>
<p>Plugin traverses project from highest (<i>application</i> in example above) to lowest (<i>instance</i> in example above) level. Data by default is located in <i>config</i> directory which may be altered by <i>configDir</i> property in plugin configuration.</p>
<div class="section">
<h4><a name="Tree_merge_algorithms"></a>Tree merge algorithms</h4>
<p>Plugin starts it work with tree merge algorithms.</p>
<div>
<pre>[...]
  &lt;configuration&gt;
    [...]
    &lt;treeAlgorithms&gt;
      [...]
      &lt;treeAlgorithm&gt;
        &lt;implementation&gt;com.griddynamics.maven.plugin.cm.algorithms.tree.ReplaceTreeMergeAlgorithm&lt;/implementation&gt;
      &lt;/treeAlgorithm&gt;
      [...]
    &lt;/treeAlgorithms&gt;
    [...]</pre></div>
<p>One of the basic tree algorithms is <i>CopyTreeMergeAlgorithm</i>. It just copies source directory to target. The first action it performs is just copies top level <i>config</i> directory to target directory. Target directory is named according to layer system names and placed into ${project.build.directory}: ${project.build.directory}/${project.artifactId}-<i>layer 2 name</i>-<i>layer 3 name</i>-<i>...</i>.</p>
<p>Another basic tree algorithms is <i>RecursiveTreeMergeAlgorithm</i>. It just walks through directory hierarchy as long as it is identical in source and target directory. If it meets file it leaves it for file merge. It does not deal with differences in trees leaving it to other tree merge algorithms.</p>
<p>You may find complete information about how <i>RecursiveTreeMergeAlgorithm</i> works, but here is the simple scenario just to draw a picture of how every merge algorithm works:</p>
<ol style="list-style-type: decimal">
<li>Plugin traverses project structure determining which configurations actually exist</li>
<li>Plugin goes through tree merge algorithms and takes the first one which is able to merge <i>/</i> directory
<ol style="list-style-type: decimal">
<li>Copy tree merge algorithm occurs to be first which is able to do that since no target directory exist. It has <i>/</i> path at the start of traversing. It just copies <i>config</i> directory to target directory.
<p>At this point first layer of configuration is merged.</p></li>
<li>Then <i>RecursiveTreeMergeAlgorithm</i> acts. It takes files from <i>config</i> directory one by one in second layer and
<ol style="list-style-type: decimal">
<li>If file is directory it looks for corresponding directory in <i>target</i> directory
<ol style="list-style-type: decimal">
<li>If directory does not exist, algorithm skips it action leaving it for next ones
<ol style="list-style-type: decimal">
<li>If next algorithm is <i>CopyTreeMergeAlgorithm</i> which just copies absent directory to the designated directory in target hierarchy.</li>
<li>If there is no algorithm for processing directory, it is just skipped.</li></ol></li>
<li>If directory exists, algorithm goes to <i>2.2.</i> step with new path Please note, that if there are other algorithms before recursive tree merge, they may handle this merge instead.</li></ol></li>
<li>If file is an ordinary file it looks for first file merge algorithm which is able to process given file. If one was found it will be used to operate with file.
<p>For example there is CopyFileMergeAlgorithm which just copies file from source to destination when no file in destination exists. Also there is OverwriteFileMergeAlgorithm which is able to replace destination file with source one if there already destination file.</p></li></ol></li>
<li>Merge process goes down to next layer and does <i>2.1.</i> - <i>2.3</i> for each item in layer</li></ol></li>
<li>When everything was merged, plugin archives output directories and attaches them to Maven project with <i>layer2item-...</i> qualifier.
<p>Since plugin starts from highest level, recursive algorithm just recreates top level directory structure in configuration target directory. If it meets a file, then file merge algorithm is looked up and applied.</p></li></ol></div>
<div class="section">
<h4><a name="File_merge_algorithms"></a>File merge algorithms</h4>
<div>
<pre>[...]
  &lt;configuration&gt;
    [...]
    &lt;fileAlgorithms&gt;
      &lt;fileAlgorithm&gt;
        &lt;implementation&gt;com.griddynamics.maven.plugin.cm.algorithms.file.PropertiesFileMergeAlgorithm&lt;/implementation&gt;
      &lt;/fileAlgorithm&gt;
      [...]</pre></div>
<p>Provided in example file merge algorithm merges Java properties files overriding property values on higher level with corresponding values on lower level. So if you have, for example my_application.properties file on <i>application</i> level which has the following contents:</p>
<div>
<pre>hostname=%{HOSTNAME_PLACEHOLDER}
port=80
error_message=&quot;Site is down, we're working to bring it up right now. Come back in few minutes&quot;</pre></div>
<p>And the corresponding file on instance level has the following contents:</p>
<div>
<pre>hostname=example.com
port=8080</pre></div>
<p>Then resulting file will contain</p>
<div>
<pre>hostname=example.com
port=8080
error_message=&quot;Site is down, we're working to bring it up right now. Come back in few minutes&quot;</pre></div>
<p>This example shows one of best practices: you use placeholders on high level and specific values on low level. Such approach may be useful, for example in the following two cases:</p>
<ol style="list-style-type: decimal">
<li>You have some mandatory properties which need to be set in environment and you want to verify you final configuration that you have specified them: just put these properties into <i>application</i> level with placeholders (you may specify %{MANDATORY_PROPERTY_NOT_SET} placeholder for example) and you will be able to notice them on lower level.</li>
<li>Along with static environments you have a pool with dynamically allocated environments. All such environments will get their <i>hostname</i> value from pool manager. So you have to use some deployment utilities to replace environment-dependent placeholders with ones which were provided by environment pool manager.
<p>These two are just examples. You may find all best practices <a href="#bestPractices">here</a>.</p></li></ol></div>
<div class="section">
<h4><a name="Data_merge_algorithms"></a>Data merge algorithms</h4>
<p>As follows from introduction there are also <i>data merge algorithms</i>. To go to their level of merge there is special file merge algorithm <i>DataFileMergeAlgorithm</i> which allows to perform merge on data level inside files. This algorithms introduce processors which are supposed to transform data in files into DOM structure. DOM structures are merged using data merge algorithm and then transformed back into files.</p>
<p>The following snippet contains example of data merge algorithm configuration:</p>
<div>
<pre>[...]
  &lt;configuration&gt;
    [...]
    &lt;dataAlgorithms&gt;
      &lt;dataAlgorithm&gt;
        &lt;implementation&gt;com.griddynamics.maven.plugin.cm.algorithms.data.OverrideDataMergeAlgorithm&lt;/implementation&gt;
        &lt;configuration&gt;
          &lt;includes&gt;
            /my.cnf/*/*
          &lt;/includes&gt;
        &lt;/configuration&gt;
      &lt;/dataAlgorithm&gt;
      &lt;dataAlgorithm&gt;
        &lt;implementation&gt;com.griddynamics.maven.plugin.cm.algorithms.data.RecursiveDataMergeAlgorithm&lt;/implementation&gt;
      &lt;/dataAlgorithm&gt;
      &lt;dataAlgorithm&gt;
        &lt;implementation&gt;com.griddynamics.maven.plugin.cm.algorithms.data.CopyDataMergeAlgorithm&lt;/implementation&gt;
      &lt;/dataAlgorithm&gt;
    &lt;/dataAlgorithms&gt;
    &lt;processors&gt;
      &lt;processor&gt;
        &lt;implementation&gt;com.griddynamics.maven.plugin.cm.algorithms.data.processor.CnfProcessor&lt;/implementation&gt;
      &lt;/processor&gt;
      [...]</pre></div>
<p>This is the most complete example for data merge. It shows how MySQL configuration may be merged using combination data merge algorithms. The order of merge algorithms is important. For example if you place <i>OverrideDataMergeAlgorithm</i> after <i>RecursiveDataMergeAlgorithm</i> the plugin will always use <i>RecursiveDataMergeAlgorithm</i> because the area of appliance of these both algorithms is the same: they work when source and target DOM nodes exist.</p>
<p>You also might notice the <i>includes</i> in plugin <i>configuration</i>. For almost all data merge algorithms, as well as for all other algorithms types, there is configuration. Configuration allows to specify items to be included or to be excluded from being processed by algorithm. Both <i>includes</i> and <i>excludes</i> elements may be specified. In this way <i>includes</i> works as <i>excludes</i> override.</p>
<p>With data merge algorithms you need to specify XPath for items in DOM tree. There may be several XPath expressions separated by semicolon. In case of file and tree merge you have to specify regular expressions. There may be only one regular expression, however it is possible to use pipe separator to specify several expressions.</p></div></div></div>
                  </div>
            </div>
          </div>

    <hr/>

    <footer>
            <div class="container-fluid">
                      <div class="row-fluid">
                              <p >Copyright &copy;                    2015
                        <a href="http://www.griddynamics.com">Grid Dynamics International, Inc.</a>.
            All rights reserved.      
                    
      </p>
        </div>

        
        
                </div>
    </footer>
        </body>
</html>
